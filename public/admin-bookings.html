<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Customer Bookings</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='28' fill='%23fff' stroke='%234b3fe0' stroke-width='4'/><path d='M32 4v56M4 32h56' stroke='%234b3fe0' stroke-width='4'/></svg>">
</head>
<style>
    body {
        font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
        background: linear-gradient(135deg, #e9e6f7 0%, #f7e6e6 100%);
        margin: 0;
        color: #222;
    }
    header {
        background: #fff;
        color: #c14b2c;
        padding: 1.5rem 2rem 1rem 2rem;
        border-radius: 0 0 2rem 2rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 24px rgba(0,0,0,0.07);
    }
    header h1 {
        font-size: 2rem;
        font-weight: 700;
        letter-spacing: 1px;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.7rem;
    }
    .header-controls { display: flex; gap: 1.2rem; align-items: center; }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
    }
    .card {
        background: #fff;
        border-radius: 2rem;
        box-shadow: 0 8px 32px rgba(0,0,0,0.10);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .section-title {
        color: #c14b2c;
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }
    .btn-outline {
        background: transparent;
        border: 2px solid #c14b2c;
        color: #c14b2c;
        border-radius: 999px;
        font-weight: 700;
        padding: 0.8rem 1.2rem;
        transition: background 0.2s, color 0.2s;
    }
    .btn-outline:hover {
        background: #f2e9e1;
        color: #c14b2c;
    }
    .danger {
        background: #e74c3c;
        color: #fff;
        border-radius: 999px;
        font-weight: 700;
        padding: 0.8rem 1.2rem;
        border: none;
        transition: background 0.2s, color 0.2s;
    }
    .danger:hover {
        background: #c0392b;
        color: #fff;
    }
    .secondary {
        background: #ff8a33;
        color: #fff;
        border-radius: 999px;
        font-weight: 700;
        padding: 0.8rem 1.2rem;
        border: none;
        transition: background 0.2s, color 0.2s;
    }
    .secondary:hover {
        background: #c14b2c;
        color: #fff;
    }
    label {
        color: #181c24;
        font-weight: 600;
    }
    input, select {
        background: rgba(233,230,247,0.5);
        color: #222;
        border-radius: 12px;
        border: 1px solid #c14b2c;
        padding: 0.8rem 1rem;
        font-size: 1rem;
    }
    input:focus, select:focus {
        border-color: #c14b2c;
        outline: none;
    }
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Customer Bookings</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='28' fill='%23fff' stroke='%234b3fe0' stroke-width='4'/><path d='M32 4v56M4 32h56' stroke='%234b3fe0' stroke-width='4'/></svg>">
</head>
<body>
    <header>
        <h1><i class="fas fa-receipt"></i> Admin Bookings</h1>
        <div class="header-controls">
            <a href="admin.html" class="btn btn-outline"><i class="fas fa-user-shield"></i> Admin</a>
            <button onclick="logout()" class="danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
            <button class="nav-toggle" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <div class="container">
        <div class="card centered">
            <h2 style="margin-top:0;">Customer Bookings</h2>
            <div class="form-group" style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap;">
                <label for="month-filter" style="min-width:140px;"><i class="far fa-calendar"></i> Filter by Month</label>
                <input type="month" id="month-filter" style="max-width:220px;">
                <button class="secondary" id="refresh-btn">Archive >30 days</button>
            </div>
            <h3 style="margin-top:1rem;">Active Bookings</h3>
            <table class="admin-table" id="admin-bookings-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Sport</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Price</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="admin-bookings-body"></tbody>
            </table>
            <h3 style="margin-top:1.5rem;">Archived Bookings</h3>
            <table class="admin-table" id="archived-bookings-table">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Sport</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Price</th>
                        <th>Paid</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="archived-bookings-body"></tbody>
            </table>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const admin = checkAuth('admin');
        function formatTime12(t) {
            if (!t) return '';
            const [hhStr, mmStr] = String(t).split(':');
            const hh = parseInt(hhStr, 10);
            const mm = parseInt(mmStr || '0', 10);
            const h12 = ((hh % 12) || 12);
            const ampm = hh >= 12 ? 'PM' : 'AM';
            return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
        }
        function renderBookings() {
            const data = getMockData();
            const tbody = document.getElementById('admin-bookings-body');
            const month = document.getElementById('month-filter').value;
            let bookings = (data.bookings || []).slice().sort((a,b) => {
                if (a.booking_date !== b.booking_date) return String(a.booking_date).localeCompare(String(b.booking_date));
                return String(a.start_time).localeCompare(String(b.start_time));
            });
            if (month) bookings = bookings.filter(b => (b.booking_date || '').startsWith(month));
            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No bookings</td></tr>';
                return;
            }
            tbody.innerHTML = bookings.map(b => `
                <tr data-id="${b.id}">
                    <td data-label="Customer">${b.user_name || ''}</td>
                    <td data-label="Phone">${b.user_mobile || ''}</td>
                    <td data-label="Sport">${b.sport_name || ''}</td>
                    <td data-label="Date">${b.booking_date || ''}</td>
                    <td data-label="Time">${formatTime12(b.start_time)} - ${formatTime12(b.end_time)}</td>
                    <td data-label="Price">₹${b.price || 0}</td>
                    <td data-label="Paid">₹${b.paid_amount || 0}</td>
                    <td data-label="Balance">₹${Math.max(0, (b.price || 0) - (b.paid_amount || 0))}</td>
                    <td data-label="Actions"><div style="display:flex; gap:8px; justify-content:center;">
                        <button class="btn-outline edit-btn" style="padding:4px 10px;">Edit</button>
                        <button class="danger delete-btn" style="padding:4px 10px;">Delete</button>
                    </div></td>
                </tr>
            `).join('');
            bindBookingActions();
        }
        function openModal(contentHtml) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.innerHTML = `
                <div class="modal-content card">
                    <button class="close-modal"><i class="fas fa-times"></i></button>
                    ${contentHtml}
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.querySelector('.close-modal').addEventListener('click', () => overlay.remove());
            return overlay;
        }
        function bindBookingActions() {
            document.querySelectorAll('#admin-bookings-body .edit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tr = btn.closest('tr');
                    const id = parseInt(tr.getAttribute('data-id'), 10);
                    const data = getMockData();
                    const b = (data.bookings || []).find(x => x.id === id) || {};
                    const modal = openModal(`
                        <h3 style="margin-top:0;">Edit Booking</h3>
                        <div class="form-group"><label>Customer</label><input id="m-user_name" type="text" value="${b.user_name || ''}"/></div>
                        <div class="form-group"><label>Phone</label><input id="m-user_mobile" type="text" value="${b.user_mobile || ''}"/></div>
                        <div class="form-group"><label>Sport</label><input id="m-sport_name" type="text" value="${b.sport_name || ''}"/></div>
                        <div class="form-group"><label>Date</label><input id="m-booking_date" type="date" value="${b.booking_date || ''}"/></div>
                        <div style="display:flex; gap:8px;">
                            <div class="form-group" style="flex:1;"><label>Start</label><input id="m-start_time" type="time" value="${(b.start_time || '').slice(0,5)}"/></div>
                            <div class="form-group" style="flex:1;"><label>End</label><input id="m-end_time" type="time" value="${(b.end_time || '').slice(0,5)}"/></div>
                        </div>
                        <div class="form-group"><label>Price/Paid</label><input id="m-price" type="number" value="${b.paid_amount || b.price || 0}"/></div>
                        <div style="display:flex; gap:8px;">
                            <button id="m-save" class="secondary" style="flex:1;">Save</button>
                            <button id="m-cancel" class="btn-outline" style="flex:1;">Cancel</button>
                        </div>
                    `);
                    modal.querySelector('#m-cancel').addEventListener('click', () => modal.remove());
                    modal.querySelector('#m-save').addEventListener('click', () => {
                        const updated = {
                            user_name: modal.querySelector('#m-user_name').value,
                            user_mobile: modal.querySelector('#m-user_mobile').value,
                            sport_name: modal.querySelector('#m-sport_name').value,
                            booking_date: modal.querySelector('#m-booking_date').value,
                            start_time: modal.querySelector('#m-start_time').value,
                            end_time: modal.querySelector('#m-end_time').value,
                            price: parseFloat(modal.querySelector('#m-price').value) || (b.price || 0),
                            paid_amount: parseFloat(modal.querySelector('#m-price').value) || b.paid_amount
                        };
                        const idx = (data.bookings || []).findIndex(x => x.id === id);
                        if (idx >= 0) {
                            data.bookings[idx] = { ...data.bookings[idx], ...updated };
                            saveMockData(data);
                            renderBookings();
                            modal.remove();
                        }
                    });
                });
            });
            document.querySelectorAll('#admin-bookings-body .delete-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tr = btn.closest('tr');
                    const id = parseInt(tr.getAttribute('data-id'), 10);
                    if (!confirm('Delete this booking?')) return;
                    const data = getMockData();
                    data.bookings = (data.bookings || []).filter(b => b.id !== id);
                    saveMockData(data);
                    renderBookings();
                });
            });
        }
        function renderArchived() {
            const data = getMockData();
            const tbody = document.getElementById('archived-bookings-body');
            const month = document.getElementById('month-filter').value;
            let bookings = (data.archivedBookings || []).slice().sort((a,b) => {
                if (a.booking_date !== b.booking_date) return String(a.booking_date).localeCompare(String(b.booking_date));
                return String(a.start_time).localeCompare(String(b.start_time));
            });
            if (month) bookings = bookings.filter(b => (b.booking_date || '').startsWith(month));
            if (bookings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No archived bookings</td></tr>';
                return;
            }
            tbody.innerHTML = bookings.map(b => `
                <tr data-id="${b.id}">
                    <td data-label="Customer">${b.user_name || ''}</td>
                    <td data-label="Phone">${b.user_mobile || ''}</td>
                    <td data-label="Sport">${b.sport_name || ''}</td>
                    <td data-label="Date">${b.booking_date || ''}</td>
                    <td data-label="Time">${formatTime12(b.start_time)} - ${formatTime12(b.end_time)}</td>
                    <td data-label="Price">₹${b.price || 0}</td>
                    <td data-label="Paid">₹${b.paid_amount || 0}</td>
                    <td data-label="Balance">₹${Math.max(0, (b.price || 0) - (b.paid_amount || 0))}</td>
                    <td data-label="Actions"><div style="display:flex; gap:8px; justify-content:center;">
                        <button class="secondary restore-btn" style="padding:4px 10px;">Restore</button>
                        <button class="danger purge-btn" style="padding:4px 10px;">Delete</button>
                    </div></td>
                </tr>
            `).join('');
            bindArchivedActions();
        }
        function bindArchivedActions() {
            document.querySelectorAll('#archived-bookings-body .restore-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tr = btn.closest('tr');
                    const id = parseInt(tr.getAttribute('data-id'), 10);
                    const data = getMockData();
                    const idx = (data.archivedBookings || []).findIndex(b => b.id === id);
                    if (idx >= 0) {
                        const b = data.archivedBookings[idx];
                        data.bookings = [...(data.bookings || []), b];
                        data.archivedBookings = data.archivedBookings.filter(x => x.id !== id);
                        saveMockData(data);
                        renderBookings();
                        renderArchived();
                    }
                });
            });
            document.querySelectorAll('#archived-bookings-body .purge-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tr = btn.closest('tr');
                    const id = parseInt(tr.getAttribute('data-id'), 10);
                    if (!confirm('Delete archived booking?')) return;
                    const data = getMockData();
                    data.archivedBookings = (data.archivedBookings || []).filter(b => b.id !== id);
                    saveMockData(data);
                    renderArchived();
                });
            });
        }
        document.getElementById('month-filter').addEventListener('change', () => { renderBookings(); renderArchived(); });
        document.getElementById('refresh-btn').addEventListener('click', () => { cleanOldBookings(30); renderBookings(); renderArchived(); });
        cleanOldBookings(30);
        renderBookings();
        renderArchived();
    </script>
</body>
</html>
