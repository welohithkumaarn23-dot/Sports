<!DOCTYPE html>
<html lang="en">
<head>
        <style>
            body {
                font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
                background: linear-gradient(135deg, #e9e6f7 0%, #f7e6e6 100%);
                margin: 0;
                color: #222;
            }
            header {
                background: #181c24;
                color: #fff;
                padding: 1.5rem 2rem 1rem 2rem;
                border-radius: 0 0 2rem 2rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            header h1 {
                font-size: 2rem;
                font-weight: 700;
                letter-spacing: 1px;
                margin: 0;
                display: flex;
                align-items: center;
                gap: 0.7rem;
            }
            .header-controls { display: flex; gap: 1.2rem; align-items: center; }
            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 1rem 1.5rem;
            }
            .card {
                background: #fff;
                border-radius: 2rem;
                box-shadow: 0 8px 32px rgba(0,0,0,0.10);
                padding: 2rem;
                margin-bottom: 2rem;
            }
            .section-title {
                color: #c14b2c;
                font-size: 2rem;
                font-weight: 700;
                margin-bottom: 1.5rem;
            }
            .btn-outline {
                background: transparent;
                border: 2px solid #c14b2c;
                color: #c14b2c;
                border-radius: 999px;
                font-weight: 700;
                padding: 0.8rem 1.2rem;
                transition: background 0.2s, color 0.2s;
            }
            .btn-outline:hover {
                background: #f2e9e1;
                color: #c14b2c;
            }
            .danger {
                background: #e74c3c;
                color: #fff;
                border-radius: 999px;
                font-weight: 700;
                padding: 0.8rem 1.2rem;
                border: none;
                transition: background 0.2s, color 0.2s;
            }
            .danger:hover {
                background: #c0392b;
                color: #fff;
            }
            .secondary {
                background: #ff8a33;
                color: #fff;
                border-radius: 999px;
                font-weight: 700;
                padding: 0.8rem 1.2rem;
                border: none;
                transition: background 0.2s, color 0.2s;
            }
            .secondary:hover {
                background: #c14b2c;
                color: #fff;
            }
            label {
                color: #181c24;
                font-weight: 600;
            }
            input, select {
                background: rgba(233,230,247,0.5);
                color: #222;
                border-radius: 12px;
                border: 1px solid #c14b2c;
                padding: 0.8rem 1rem;
                font-size: 1rem;
            }
            input:focus, select:focus {
                border-color: #c14b2c;
                outline: none;
            }
            /* Improved responsive header and body styles for admin.html */
            @media (max-width: 1023px) {
              header {
                position: static !important;
                top: auto !important;
                left: auto !important;
                right: auto !important;
                margin: 0 auto !important;
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                text-align: center;
                box-shadow: 0 4px 24px rgba(0,0,0,0.07);
                background: #181c24;
                color: #fff;
              }
              .header-controls {
                flex-direction: column;
                gap: 0.7rem;
                margin-top: 0.5rem;
                width: 100%;
                align-items: center;
                justify-content: center;
              }
              h1 {
                width: 100%;
                text-align: center;
                margin: 0 auto;
              }
            }
            @media (max-width: 767px) {
              body {
                padding: 0.5rem;
                background: linear-gradient(135deg, #e9e6f7 0%, #f7e6e6 100%);
              }
              .container {
                padding: 0.5rem;
                max-width: 100vw;
              }
              .section-title {
                font-size: 1.2rem;
                margin-bottom: 0.7rem;
                text-align: center;
              }
              .grid {
                grid-template-columns: 1fr;
                gap: 0.7rem;
              }
              .card {
                padding: 0.7rem;
                border-radius: 1rem;
                margin-bottom: 1rem;
              }
              .form-group {
                margin-bottom: 1rem;
              }
              label {
                font-size: 1rem;
              }
              input, select {
                font-size: 1rem;
                padding: 0.6rem 0.7rem;
                width: 100%;
                box-sizing: border-box;
              }
              button, .btn-outline, .danger, .secondary {
                width: 100%;
                font-size: 1rem;
                padding: 0.7rem 1rem;
                margin-bottom: 0.5rem;
              }
            }
        </style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Academy - Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='28' fill='%23fff' stroke='%234b3fe0' stroke-width='4'/><path d='M32 4v56M4 32h56' stroke='%234b3fe0' stroke-width='4'/></svg>">
</head>
<body>
    <header>
        <h1><i class="fas fa-user-shield"></i> Admin Panel</h1>
        <div class="header-controls">
            <span class="user-info">Administrator</span>
            <a href="admin-bookings.html" class="btn btn-outline"><i class="fas fa-receipt"></i> Bookings</a>
            <button onclick="logout()" class="danger"><i class="fas fa-sign-out-alt"></i> Logout</button>
            <button class="nav-toggle" aria-label="Toggle navigation"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <div class="container">
        <h2 class="section-title">Manage Resources</h2>
        <div class="grid">
            <div class="card" id="add-tournament">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-trophy"></i> Add Tournament</h3>
                <form id="add-tournament-form">
                    <div class="form-group">
                        <label>Tournament Name</label>
                        <input type="text" id="t-name" required placeholder="e.g. District Badminton Championship">
                    </div>
                    <div class="form-group">
                        <label>Sport Name</label>
                        <input type="text" id="t-sport" required placeholder="e.g. Badminton">
                    </div>
                    <div style="display:flex; gap:1rem;">
                        <div class="form-group" style="flex:1;">
                            <label>Start Date</label>
                            <input type="date" id="t-start" required>
                        </div>
                        <div class="form-group" style="flex:1;">
                            <label>End Date</label>
                            <input type="date" id="t-end" style="width: 90%">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="t-location" placeholder="Venue">
                    </div>
                    <div class="form-group">
                        <label>Registration Deadline</label>
                        <input type="date" id="t-deadline" placeholder="YYYY-MM-DD">
                    </div>
                    <div class="form-group">
                        <label>Image (JPG/PNG)</label>
                        <input type="file" id="t-image" accept="image/jpeg,image/png,image/jpg" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="t-desc" placeholder="Brief details">
                    </div>
                    <button type="submit" class="secondary" style="width: 100%;">Create Tournament</button>
                </form>
            </div>
            <div class="card" id="add-sport">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-plus-circle"></i> Add New Sport</h3>
                <form id="add-sport-form">
                    <div class="form-group">
                        <label>Sport Name</label>
                        <input type="text" id="sport-name" required placeholder="e.g. Swimming">
                    </div>
                    <div class="form-group">
                        <label>Sport Image (JPG/PNG)</label>
                        <input type="file" id="sport-image" accept="image/jpeg,image/png,image/jpg" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" id="sport-desc" placeholder="Brief details">
                    </div>
                    <button type="submit" style="width: 100%;">Add Sport</button>
                </form>
            </div>

            <div class="card" id="add-slot">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-clock"></i> Add Slot Template</h3>
                <form id="add-slot-form">
                    <div class="form-group">
                        <label>Select Sport</label>
                        <select id="sport-select" name="sport" required></select>
                    </div>
                    <div id="time-row" style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label>Start Time</label>
                            <input type="time" id="start-time" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>End Time</label>
                            <input type="time" id="end-time" required>
                        </div>
                    </div>
                    <div id="price-group" class="form-group">
                        <label>Price</label>
                        <input type="number" id="price" required placeholder="e.g. 500">
                    </div>
                    <button type="submit" class="secondary" style="width: 100%;">Add Slot</button>
                </form>
            </div>
            <div class="card" id="manage-tournaments">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-trophy"></i> Manage Tournaments</h3>
                <div id="tournaments-list"></div>
            </div>
            <div class="card" id="existing-slots">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-list"></i> Existing Slots</h3>
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <label style="min-width:80px;">Sport</label>
                    <select id="slot-filter-sport" style="flex:1;"></select>
                </div>
                <div id="slots-simple-list"></div>
            </div>
            <div class="card" id="manage-sports">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-dumbbell"></i> Manage Sports</h3>
                <div id="sports-manage-list"></div>
            </div>
            <div class="card" id="settings">
                <h3 style="margin-top: 0; color: var(--primary-color);"><i class="fas fa-cog"></i> Settings</h3>
                <form id="settings-form">
                    <div class="form-group">
                        <label>WhatsApp API Key</label>
                        <input type="text" id="wa-api-key" placeholder="Enter provider API key">
                    </div>
                    <div class="form-group">
                        <label>Sender WhatsApp Number</label>
                        <input type="text" id="wa-sender" placeholder="e.g. 919876543210">
                        <small style="color:var(--text-light)">Used as From number for receipts</small>
                    </div>
                    <button type="submit" class="secondary" style="width:100%;">Save Settings</button>
                </form>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const user = checkAuth();
        if (user.role !== 'admin') {
            window.location.href = 'dashboard.html';
        }

        async function loadSportsForSelect() {
            // Fetch sports from backend
            let sports = [];
            try {
                const response = await fetch('http://localhost:5000/sports');
                sports = await response.json();
            } catch (e) {
                sports = [];
            }
            const select = document.getElementById('sport-select');
            if (select) {
                select.innerHTML = sports.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                select.addEventListener('change', toggleSlotFormMode);
                toggleSlotFormMode();
            }
            const filterSel = document.getElementById('slot-filter-sport');
            if (filterSel) {
                filterSel.innerHTML = sports.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                filterSel.addEventListener('change', renderSlotsSimple);
            }
        }

        // Prefill and save WhatsApp Settings
        (function initSettings(){
            const data = getMockData();
            const cfg = data.whatsapp || {};
            const apiEl = document.getElementById('wa-api-key');
            const senderEl = document.getElementById('wa-sender');
            if (apiEl) apiEl.value = cfg.api_key || '';
            if (senderEl) senderEl.value = cfg.sender || '';
            const form = document.getElementById('settings-form');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const d = getMockData();
                    d.whatsapp = { api_key: apiEl.value.trim(), sender: senderEl.value.trim() };
                    saveMockData(d);
                    alert('Settings saved');
                });
            }
        })();

        document.getElementById('add-tournament-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get all form values
            const name = document.getElementById('t-name').value.trim();
            const sport_name = document.getElementById('t-sport').value.trim();
            const start_date = document.getElementById('t-start').value;
            const end_date = document.getElementById('t-end').value;
            const location = document.getElementById('t-location').value.trim();
            const registration_deadline = document.getElementById('t-deadline').value;
            const description = document.getElementById('t-desc').value.trim();
            const fileInput = document.getElementById('t-image');
            const file = fileInput && fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
            
            // Validation
            if (!name) {
                alert('Please enter tournament name');
                return;
            }
            if (!sport_name) {
                alert('Please enter sport name');
                return;
            }
            if (!start_date) {
                alert('Please select start date');
                return;
            }
            if (!end_date) {
                alert('Please select end date');
                return;
            }
            if (!file) {
                alert('Please select an image file');
                return;
            }
            
            const allowed = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!allowed.includes(file.type)) {
                alert('Only JPG and PNG images are allowed');
                return;
            }
            
            // Convert image to base64
            const dataUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            
            const payload = {
                name: name,
                sport_name: sport_name,
                start_date: start_date,
                end_date: end_date,
                location: location || '',
                registration_deadline: registration_deadline || '',
                image_url: dataUrl,
                description: description || ''
            };

            console.log("Sending tournament payload:", payload);

            try {
                const response = await fetch("http://localhost:5000/add-tournament", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });

                console.log("Response status:", response.status);
                const responseData = await response.json();
                console.log("Response data:", responseData);

                if (!response.ok) {
                    throw new Error(responseData.error || "Failed to add tournament");
                }

                alert("Tournament added successfully!");
                e.target.reset();
                await renderTournaments();
            } catch (error) {
                console.error("Error adding tournament:", error);
                alert("Failed to add tournament: " + error.message);
            }
        });

        document.getElementById('add-sport-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('sport-name').value.trim();
            const imageEl = document.getElementById('sport-image');
            const desc = document.getElementById('sport-desc').value.trim();
            const file = imageEl && imageEl.files && imageEl.files[0] ? imageEl.files[0] : null;
            // Validation
            if (!name) {
                alert('Please enter sport name');
                return;
            }
            if (!file) {
                alert('Please select an image file');
                return;
            }
            const allowed = ['image/jpeg', 'image/png', 'image/jpg'];
            if (!allowed.includes(file.type)) {
                alert('Only JPG and PNG images are allowed');
                return;
            }
            const dataUrl = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
            const payload = {
                name: name,
                image_url: dataUrl,
                description: desc || ''
            };
            try {
                const response = await fetch("http://localhost:5000/add-sport", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(responseData.error || "Failed to add sport");
                }
                alert("Sport added successfully!");
                e.target.reset();
                await loadSportsForSelect();
                await renderSportsManage();
            } catch (error) {
                alert("Failed to add sport: " + error.message);
            }
        });

        function toggleSlotFormMode() {
            const data = getMockData();
            const sportId = parseInt(document.getElementById('sport-select').value, 10);
            const sport = (data.sports || []).find(s => s.id === sportId);
            const isGym = sport && String(sport.name).toLowerCase() === 'gym';
            const timeRow = document.getElementById('time-row');
            const priceGroup = document.getElementById('price-group');
            const gymPlan = document.getElementById('gym-plan-container');
            const gymPrice = document.getElementById('gym-price-container');
            const startEl = document.getElementById('start-time');
            const endEl = document.getElementById('end-time');
            const priceEl = document.getElementById('price');
            const gymPriceEl = document.getElementById('gym-price');
            if (timeRow) timeRow.style.display = isGym ? 'none' : 'flex';
            if (priceGroup) priceGroup.style.display = isGym ? 'none' : 'block';
            if (gymPlan) gymPlan.style.display = isGym ? 'block' : 'none';
            if (gymPrice) gymPrice.style.display = isGym ? 'block' : 'none';
            if (startEl) { startEl.required = !isGym; startEl.disabled = isGym; }
            if (endEl) { endEl.required = !isGym; endEl.disabled = isGym; }
            if (priceEl) { priceEl.required = !isGym; priceEl.disabled = isGym; }
            if (gymPriceEl) { gymPriceEl.required = isGym; gymPriceEl.disabled = !isGym; }
        }

        document.getElementById('add-slot-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sportId = document.getElementById('sport-select').value;
            const start = document.getElementById('start-time').value;
            const end = document.getElementById('end-time').value;
            const price = document.getElementById('price').value;
            // Only handle non-gym slots for now (as per backend-driven logic)
            try {
                const payload = {
                    sport_id: parseInt(sportId, 10),
                    start_time: start,
                    end_time: end,
                    price: parseFloat(price)
                };
                const response = await fetch('http://localhost:5000/add-slot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to add slot');
                }
                alert('Slot added successfully');
                e.target.reset();
                // Only re-render slots for the selected sport
                const filterSel = document.getElementById('slot-filter-sport');
                if (filterSel && parseInt(filterSel.value, 10) === parseInt(sportId, 10)) {
                    renderSlotsSimple();
                }
            } catch (error) {
                alert('Failed to add slot: ' + error.message);
            }
        });

        function formatTime12(t) {
            if (!t) return '';
            const parts = String(t).split(':');
            const hh = parseInt(parts[0], 10);
            const mm = parseInt(parts[1] || '0', 10);
            const h12 = ((hh % 12) || 12);
            const ampm = hh >= 12 ? 'PM' : 'AM';
            return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`;
        }
        function renderSlotsSimple() {
            // Fetch slots from backend and render only for selected sport
            const div = document.getElementById('slots-simple-list');
            const filterSel = document.getElementById('slot-filter-sport');
            let sportId = null;
            if (filterSel && filterSel.value) {
                sportId = parseInt(filterSel.value, 10);
            }
            // Only fetch if a sport is selected
            if (!sportId) {
                div.innerHTML = '<p>Please select a sport</p>';
                return;
            }
            fetch('http://localhost:5000/slots?sport_id=' + sportId)
                .then(res => res.json())
                .then(slots => {
                    // Explicitly filter slots by sport_id in frontend
                    const filteredSlots = (slots || []).filter(s => parseInt(s.sport_id, 10) === parseInt(sportId, 10));
                    if (!filteredSlots || filteredSlots.length === 0) {
                        div.innerHTML = '<p>No slots</p>';
                        return;
                    }
                    div.innerHTML = `
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:8px;">
                            ${filteredSlots.map(s => `
                                <div class="card slot-chip" data-id="${s.id}" style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px;">
                                    <div>
                                        <div style="font-weight:600;">${formatTime12(s.start_time)} - ${formatTime12(s.end_time)}</div>
                                        <div style="color:var(--text-light);">₹${s.price}</div>
                                    </div>
                                    <div style="display:flex; gap:6px;">
                                        <button class="secondary edit-slot" style="padding:4px 8px;"><i class="fas fa-pen"></i></button>
                                        <button class="danger delete-slot" style="padding:4px 8px;"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    bindSlotActionsSimple();
                })
                .catch(() => {
                    div.innerHTML = '<p>Error loading slots</p>';
                });
        }

        function bindSlotActionsSimple() {
            // Fetch sports for edit dropdown
            fetch('http://localhost:5000/sports')
                .then(res => res.json())
                .then(sports => {
                    document.querySelectorAll('#slots-simple-list .edit-slot').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const chip = btn.closest('.slot-chip');
                            const id = parseInt(chip.getAttribute('data-id'), 10);
                            // Fetch slot details from backend
                            fetch('http://localhost:5000/slots/' + id)
                                .then(res => res.json())
                                .then(s => {
                                    chip.innerHTML = `
                                        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; flex:1;">
                                            <select class="slot-sport">${sports.map(sp => `<option value="${sp.id}" ${sp.id===s.sport_id?'selected':''}>${sp.name}</option>`).join('')}</select>
                                            <input class="slot-price" type="number" value="${s.price}" />
                                            <input class="slot-start" type="time" value="${s.start_time.slice(0,5)}" />
                                            <input class="slot-end" type="time" value="${s.end_time.slice(0,5)}" />
                                        </div>
                                        <div style="display:flex; gap:6px;">
                                            <button class="secondary save-slot" style="padding:4px 8px;">Save</button>
                                            <button class="secondary cancel-slot" style="padding:4px 8px;">Cancel</button>
                                        </div>
                                    `;
                                    chip.querySelector('.save-slot').addEventListener('click', async () => {
                                        const sportId = parseInt(chip.querySelector('.slot-sport').value, 10);
                                        const start = chip.querySelector('.slot-start').value;
                                        const end = chip.querySelector('.slot-end').value;
                                        const price = parseFloat(chip.querySelector('.slot-price').value);
                                        try {
                                            const payload = {
                                                sport_id: sportId,
                                                start_time: start,
                                                end_time: end,
                                                price: price
                                            };
                                            const response = await fetch('http://localhost:5000/update-slot/' + id, {
                                                method: 'PUT',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                            });
                                            if (!response.ok) {
                                                throw new Error('Failed to update slot');
                                            }
                                            alert('Slot updated successfully');
                                            renderSlotsSimple();
                                        } catch (error) {
                                            alert('Failed to update slot: ' + error.message);
                                        }
                                    });
                                    chip.querySelector('.cancel-slot').addEventListener('click', () => {
                                        renderSlotsSimple();
                                    });
                                });
                        });
                    });
                    document.querySelectorAll('#slots-simple-list .delete-slot').forEach(btn => {
                        btn.addEventListener('click', async () => {
                            const chip = btn.closest('.slot-chip');
                            const id = parseInt(chip.getAttribute('data-id'), 10);
                            if (!confirm('Delete slot?')) return;
                            try {
                                const response = await fetch('http://localhost:5000/delete-slot/' + id, {
                                    method: 'DELETE'
                                });
                                if (!response.ok) {
                                    throw new Error('Failed to delete slot');
                                }
                                alert('Slot deleted successfully');
                                renderSlotsSimple();
                            } catch (error) {
                                alert('Failed to delete slot: ' + error.message);
                            }
                        });
                    });
                });
        }

        async function renderTournaments() {
            try {
                const response = await fetch("http://localhost:5000/tournaments");
                const tournaments = await response.json();
                const div = document.getElementById('tournaments-list');
                
                if (!tournaments || tournaments.length === 0) {
                    div.innerHTML = '<p>No tournaments</p>';
                    return;
                }

                div.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:8px;">
                        ${tournaments.map(t => `
                            <div class="card t-chip" data-id="${t.id}" style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px;">
                                <div>
                                    <div style="font-weight:600;">${t.name || ''}</div>
                                    <div style="color:var(--text-light);">${t.sport_name || ''} • ${(t.start_date || '')} - ${(t.end_date || '')}</div>
                                </div>
                                <div style="display:flex; gap:6px;">
                                    <button class="secondary edit-tournament" style="padding:4px 8px;"><i class="fas fa-pen"></i></button>
                                    <button class="danger delete-tournament" data-id="${t.id}" style="padding:4px 8px;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                bindTournamentActions();
            } catch (error) {
                console.error("Error loading tournaments:", error);
                const div = document.getElementById('tournaments-list');
                div.innerHTML = '<p>Error loading tournaments</p>';
            }
        }

        function bindTournamentActions() {
            document.querySelectorAll('.edit-tournament').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const chip = btn.closest('.t-chip');
                    const id = parseInt(chip.getAttribute('data-id'), 10);
                    
                    // Fetch the tournament data from API
                    const response = await fetch(`http://localhost:5000/tournaments`);
                    const tournaments = await response.json();
                    const t = tournaments.find(tt => tt.id === id) || {};
                    
                    chip.innerHTML = `
                        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; flex:1;">
                            <input class="t-name" type="text" value="${t.name || ''}" placeholder="Name" />
                            <input class="t-sport" type="text" value="${t.sport_name || ''}" placeholder="Sport" />
                            <input class="t-start" type="date" value="${t.start_date || ''}" />
                            <input class="t-end" type="date" value="${t.end_date || ''}" />
                            <input class="t-location" type="text" value="${t.location || ''}" placeholder="Location" />
                            <input class="t-deadline" type="date" value="${t.registration_deadline || ''}" />
                            <input class="t-image" type="file" accept="image/jpeg,image/png,image/jpg" />
                            <input class="t-desc" type="text" value="${t.description || ''}" placeholder="Description" />
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="secondary save-tournament" style="padding:4px 8px;">Save</button>
                            <button class="secondary cancel-tournament" style="padding:4px 8px;">Cancel</button>
                        </div>
                    `;
                    
                    chip.querySelector('.save-tournament').addEventListener('click', async () => {
                        let newImageUrl = t.image_url || '';
                        const imgInput = chip.querySelector('.t-image');
                        const f = imgInput && imgInput.files && imgInput.files[0] ? imgInput.files[0] : null;
                        
                        if (f) {
                            const allowed = ['image/jpeg', 'image/png', 'image/jpg'];
                            if (!allowed.includes(f.type)) {
                                alert('Only JPG and PNG images are allowed');
                                return;
                            }
                            newImageUrl = await new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = () => resolve(reader.result);
                                reader.onerror = reject;
                                reader.readAsDataURL(f);
                            });
                        }
                        
                        const payload = {
                            name: chip.querySelector('.t-name').value,
                            sport_name: chip.querySelector('.t-sport').value,
                            start_date: chip.querySelector('.t-start').value,
                            end_date: chip.querySelector('.t-end').value,
                            location: chip.querySelector('.t-location').value,
                            registration_deadline: chip.querySelector('.t-deadline').value,
                            image_url: newImageUrl,
                            description: chip.querySelector('.t-desc').value
                        };
                        
                        try {
                            const response = await fetch(`http://localhost:5000/update-tournament/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            
                            if (response.ok) {
                                alert('Tournament updated successfully');
                                renderTournaments();
                            } else {
                                alert('Failed to update tournament');
                            }
                        } catch (error) {
                            console.error("Error updating tournament:", error);
                            alert('Error updating tournament');
                        }
                    });
                    
                    chip.querySelector('.cancel-tournament').addEventListener('click', () => {
                        renderTournaments();
                    });
                });
            });
            
            document.querySelectorAll('.delete-tournament').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = parseInt(btn.getAttribute('data-id'), 10);
                    if (!confirm('Delete tournament?')) return;
                    
                    try {
                        const response = await fetch(`http://localhost:5000/delete-tournament/${id}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            alert('Tournament deleted successfully');
                            renderTournaments();
                        } else {
                            alert('Failed to delete tournament');
                        }
                    } catch (error) {
                        console.error("Error deleting tournament:", error);
                        alert('Error deleting tournament');
                    }
                });
            });
        }

        async function renderSportsManage() {
            try {
                const response = await fetch("http://localhost:5000/sports");
                const sports = await response.json();
                const div = document.getElementById('sports-manage-list');
                if (!sports || sports.length === 0) {
                    div.innerHTML = '<p>No sports</p>';
                    return;
                }
                div.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:8px;">
                        ${sports.map(s => `
                            <div class="card sp-chip" data-id="${s.id}" style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px;">
                                <div>
                                    <div style="font-weight:600;">${s.name || ''}</div>
                                    <div style="color:var(--text-light);">${s.description || ''}</div>
                                </div>
                                <div style="display:flex; gap:6px;">
                                    <button class="secondary edit-sport" style="padding:4px 8px;"><i class="fas fa-pen"></i></button>
                                    <button class="danger delete-sport" data-id="${s.id}" style="padding:4px 8px;"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                bindSportsActions();
            } catch (error) {
                const div = document.getElementById('sports-manage-list');
                div.innerHTML = '<p>Error loading sports</p>';
            }
        }

        function bindSportsActions() {
            document.querySelectorAll('#sports-manage-list .edit-sport').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const chip = btn.closest('.sp-chip');
                    const id = parseInt(chip.getAttribute('data-id'), 10);
                    // Fetch sport details from backend
                    let s = {};
                    try {
                        const response = await fetch(`http://localhost:5000/sports/${id}`);
                        if (response.ok) {
                            s = await response.json();
                        }
                    } catch (e) {}
                    chip.innerHTML = `
                        <div style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px; flex:1;">
                            <input class="sp-name" type="text" value="${s.name || ''}" placeholder="Name" />
                            <input class="sp-image" type="text" value="${s.image_url || ''}" placeholder="Image URL" />
                            <input class="sp-desc" type="text" value="${s.description || ''}" placeholder="Description" />
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="secondary save-sport" style="padding:4px 8px;">Save</button>
                            <button class="secondary cancel-sport" style="padding:4px 8px;">Cancel</button>
                        </div>
                    `;
                    chip.querySelector('.save-sport').addEventListener('click', async () => {
                        const payload = {
                            name: chip.querySelector('.sp-name').value,
                            image_url: chip.querySelector('.sp-image').value,
                            description: chip.querySelector('.sp-desc').value
                        };
                        try {
                            const response = await fetch(`http://localhost:5000/update-sport/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (response.ok) {
                                alert('Sport updated successfully');
                                renderSportsManage();
                                loadSportsForSelect();
                            } else {
                                alert('Failed to update sport');
                            }
                        } catch (error) {
                            alert('Error updating sport');
                        }
                    });
                    chip.querySelector('.cancel-sport').addEventListener('click', () => {
                        renderSportsManage();
                    });
                });
            });
            document.querySelectorAll('#sports-manage-list .delete-sport').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const id = parseInt(btn.getAttribute('data-id'), 10);
                    if (!confirm('Delete sport?')) return;
                    try {
                        const response = await fetch(`http://localhost:5000/delete-sport/${id}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            alert('Sport deleted successfully');
                            renderSportsManage();
                            loadSportsForSelect();
                        } else {
                            alert('Failed to delete sport');
                        }
                    } catch (error) {
                        alert('Error deleting sport');
                    }
                });
            });
        }

        loadSportsForSelect();
        renderSlotsSimple();
        renderTournaments();
        renderSportsManage();
    </script>
</body>
</html>
